cmake_minimum_required(VERSION 3.10)

set(TEST_BINARY_DIR "${CMAKE_BINARY_DIR}/psesca_ext")
set(TEST_EXT_BINARY_DIR "${CMAKE_INSTALL_PREFIX}/lib")

file(TO_CMAKE_PATH "$ENV{PATH}" TEST_PATH)
file(TO_CMAKE_PATH "$ENV{LD_LIBRARY_PATH}" TEST_LDPATH)

file(TO_NATIVE_PATH 
	"${TEST_BINARY_DIR};${TEST_EXT_BINARY_DIR};${TEST_PATH}"
	TEST_PATH)
file(TO_NATIVE_PATH 
	"${TEST_BINARY_DIR};${TEST_EXT_BINARY_DIR};${TEST_LDPATH}"
	TEST_LDPATH)

string(REGEX REPLACE ";" "\\\\;" TEST_PATH "${TEST_PATH}")
string(REGEX REPLACE ";" "\\\\;" TEST_LDPATH "${TEST_LDPATH}")

foreach(TEST basic highlevel main)
	add_test(NAME ${TEST}
		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
		COMMAND ${PYTHON_EXECUTABLE} ${TEST}.py)
	set_tests_properties(${TEST} PROPERTIES ENVIRONMENT
		"LD_LIBRARY_PATH=$<SHELL_PATH:${TEST_LDPATH}>;PATH=${TEST_PATH};PYTHONPATH=${CMAKE_BINARY_DIR}/tests")
endforeach()
